sudo: required
language: java
jdk:
- openjdk11
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_8e6942744794_key -iv $encrypted_8e6942744794_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
- "./gradlew build && docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT ."
- |
  set -e
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    ./set-image.sh prod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com

    git add preprod/$APP_NAME/naiserator.yaml
    git add prod/$APP_NAME/naiserator.yaml
    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

    cd ..
    fi
before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
after_success:
- "./triggerbuild.sh helse-e2e"
env:
  global:
  - APP_NAME=spenn
  - DOCKER_IMG_NAME=navikt/spenn
  - GITHUB_APP_ID=19726
  - secure: hmCOI5n804+Uya85t4hi9YSr8NGiw2AkSFce3m9LKRrEr3JuJD5gNqxApQgx1mUCRNKVUR3T7H3XvFNZNQkOG8E+pEhqzcW1T0xFvsrIL7BOUEb0t7vGagYqnOLPVfnqR8U2Jrw/vi8FTdnIAhHd+IkZIL69LKOfjVmXKfK1V7o2CvCH0H5ke5HIzBEMD1sYCdLoNJK7p23QUJ6A/pOZ4kvJeFWxeHDZZ0aYtGIaSJZPBlAb693M5w8oipqnd258LMDPmvml2JcSHMuANBV0tn8PfcLWDIwLlb3DyN4PiVfl2yqC+RYJzUIXA1FQn0ScO6M7s2hZMXeLu7A18qcSYuCCarrx5gJIRbnKfkF5rVxS7PapPGnQcEK3WhGZZPA5KrgWy7VxyKGkuhcBvDs9DhLuDLJ0PnAT2z/yfpzn2a/nCFre50sgKSKidnVTmoGKtFQ+PBRqm42ZIcb3wfYZ9GqNRKJKbE8GUrJI1MnhxBRPEqZS/ZND4kSe0R0+AlG2OlaEFf52XMWUhBIz1YZDlfusCQ1Ccj8TsbuElt7fQnA1/owzjzEHDEJ5hPCbtGJvcVsiLvce6Gp1L5BxmaoxJrLscEsHqqJRHXyZP5bs7y1fMXfbUCwe9p2pDaxztXKDUW+8fA9/wlGKQ3uMHc5hp/SYqeUPn8UVX4UXqtjNAsc=
