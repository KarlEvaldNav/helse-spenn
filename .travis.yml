sudo: required
language: java
jdk:
- openjdk11
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_8e6942744794_key -iv $encrypted_8e6942744794_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
- "./gradlew build && docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT ."
- |
  set -e
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    ./set-image.sh prod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com

    git add preprod/$APP_NAME/naiserator.yaml
    git add prod/$APP_NAME/naiserator.yaml
    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

    cd ..
    fi
before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
after_success:
- "./triggerbuild.sh helse-e2e"
env:
  global:
  - APP_NAME=spenn
  - DOCKER_IMG_NAME=navikt/spenn
  - GITHUB_APP_ID=19726
  - DOCKER_USERNAME=naviktdocker
  - secure: WcPpbTpYPjRcKztD7vx55lby4xAHCGOAcBILHkKb8kzY/E//Qae5TAB/BW6xEFqa93DdyUBDVf4R94SIL6mRZuLlWHKr7CTMKHhAR/Ori9UHO0AlwrzPocstSnkJUc6YAPI9vtTczOP9POr3Q16wocfEYORbr036dW63EqxZRW4fKxeiGKC/5o/xfr2FoX+wdUiQwb2VVQS6drubL2IX6MAPL0tgEaQKVhUdQtjC8OGsv8CcU8QKoqpJ/GHc1H2QRtyTOCV7Wk0gi/KVxW85+JnsuZoHDcqdnHOw9dXq1gxCwUvWDHSi0YwU0tKll3i38WdYzbaKt7KZWDwccr4XxWgu/PzYfjfs5egp1T1gF8Gf/nx1OFAQjHpS9dLLcoJUDle4CsMRVi7JeCC5ITEU3lht1CjgMAfdlARfkzL0foGbKdpc1tyNU99k2mvOBVw0wfI3vDPEDgNQT8XmJzlsiBdM1geVG6vDvqbwDwdTvdUCh75B31vO7jpOcYS+ckG7dEYYLjSApShLX/BKOoAitzncNBbPqBUJkF5QxMl5uBAoIB4kilSMwD4MWJPu82/jYOR4Z/NhlYcnA67nKJiOYgV2cJTNKfIQT1N7vn5SzR+XioP10RWJCeKjcCC+9NYTuUDeMHvA1ABpSRAoWXd8LiU5LcIdbzxVihSEspgUu7Y=
